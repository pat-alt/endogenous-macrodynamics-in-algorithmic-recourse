<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Endogenous Macrodynamics in Algorithmic Recourse - 3&nbsp; Experimental Results</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../sections/generators/index.html" rel="next">
<link href="../../sections/data_preprocessing/index.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Experimental Results</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Endogenous Macrodynamics in Algorithmic Recourse</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../sections/data_preprocessing/index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Preprocessing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../sections/experiments/index.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Experimental Results</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../sections/generators/index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Generators</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-app-synthetic" id="toc-sec-app-synthetic" class="nav-link active" data-scroll-target="#sec-app-synthetic"><span class="toc-section-number">3.0.1</span>  Synthetic Data</a></li>
  <li><a href="#real-world-data" id="toc-real-world-data" class="nav-link" data-scroll-target="#real-world-data"><span class="toc-section-number">3.0.2</span>  Real-World Data</a></li>
  <li><a href="#mitigation-strategies" id="toc-mitigation-strategies" class="nav-link" data-scroll-target="#mitigation-strategies"><span class="toc-section-number">3.0.3</span>  Mitigation Strategies</a></li>
  <li><a href="#real-world" id="toc-real-world" class="nav-link" data-scroll-target="#real-world"><span class="toc-section-number">3.1</span>  Real World</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Experimental Results</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This is a supplementary appendix to the research paper <strong>Endogenous Macrodynamics in Algorithmic Recourse</strong>. It contains all of the experimental results, including those not highlighted in the actual paper. It also links to additional information about the proposed mitigation strategies.</p>
<section id="sec-app-synthetic" class="level3" data-number="3.0.1">
<h3 data-number="3.0.1" class="anchored" data-anchor-id="sec-app-synthetic"><span class="header-section-number">3.0.1</span> Synthetic Data</h3>
<p>This notebook was used to run the experiments for the synthetic datasets and can be used to reproduce the results in the paper. In the following we first run the experiments and then generate visualizations and tables.</p>
<section id="experiment" class="level4" data-number="3.0.1.1">
<h4 data-number="3.0.1.1" class="anchored" data-anchor-id="experiment"><span class="header-section-number">3.0.1.1</span> Experiment</h4>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>LogisticRegression, </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>FluxModel, </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>FluxEnsemble,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>generators <span class="op">=</span> <span class="fu">Dict</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Greedy<span class="op">=&gt;</span><span class="fu">GreedyGenerator</span>(), </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Generic<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>REVISE<span class="op">=&gt;</span><span class="fu">REVISEGenerator</span>(),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>DICE<span class="op">=&gt;</span><span class="fu">DiCEGenerator</span>(),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>max_obs <span class="op">=</span> <span class="fl">1000</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>catalogue <span class="op">=</span> <span class="fu">load_synthetic</span>(max_obs; data_dir<span class="op">=</span>data_path)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>choices <span class="op">=</span> [</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>linearly_separable, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>overlapping, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>circles, </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>moons,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>data_sets <span class="op">=</span> <span class="fu">filter</span>(p <span class="op">-&gt;</span> p[<span class="fl">1</span>] <span class="kw">in</span> choices, catalogue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>experiments <span class="op">=</span> <span class="fu">set_up_experiments</span>(data_sets,models,generators)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-test-before">Figure&nbsp;<span>3.1</span></a> shows the test data before running the experiment.</p>
<div id="fig-test-before" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>plts <span class="op">=</span> []</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (exp_name, exp_) <span class="kw">in</span> experiments</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (M_name, M) <span class="kw">in</span> exp_.models</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="fu">round</span>(<span class="fu">model_evaluation</span>(M, exp_.test_data),digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        plt <span class="op">=</span> <span class="fu">plot</span>(M, exp_.test_data, title<span class="op">=</span><span class="st">"</span><span class="sc">$</span>exp_name<span class="st">;</span><span class="sc">\n</span><span class="st"> </span><span class="sc">$</span>M_name<span class="st"> (</span><span class="sc">$</span>score<span class="st">)"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Errors:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        ids <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">vec</span>(<span class="fu">round</span>.(<span class="fu">probs</span>(M, exp_.test_data.X)) <span class="op">.!=</span> exp_.test_data.y))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        x_wrongly_labelled <span class="op">=</span> exp_.test_data.X[<span class="op">:</span>,ids]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scatter!</span>(plt, x_wrongly_labelled[<span class="fl">1</span>,<span class="op">:</span>], x_wrongly_labelled[<span class="fl">2</span>,<span class="op">:</span>], ms<span class="op">=</span><span class="fl">7.5</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        plts <span class="op">=</span> <span class="fu">vcat</span>(plts<span class="op">...</span>, plt)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>plt <span class="op">=</span> <span class="fu">plot</span>(plts<span class="op">...</span>, layout<span class="op">=</span>(<span class="fu">length</span>(choices),<span class="fu">length</span>(models)),size<span class="op">=</span>(<span class="fu">length</span>(choices)<span class="op">*</span><span class="fl">300</span>,<span class="fu">length</span>(models)<span class="op">*</span><span class="fl">300</span>))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">savefig</span>(plt, <span class="fu">joinpath</span>(www_path,<span class="st">"models_test_before.png"</span>))</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.1: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
<p><a href="#fig-train-before">Figure&nbsp;<span>3.2</span></a> shows the training data before running the experiment.</p>
<div id="fig-train-before" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">AlgorithmicRecourseDynamics.Models</span>: model_evaluation</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>plts <span class="op">=</span> []</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (exp_name, exp_) <span class="kw">in</span> experiments</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (M_name, M) <span class="kw">in</span> exp_.models</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="fu">round</span>(<span class="fu">model_evaluation</span>(M, exp_.train_data),digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        plt <span class="op">=</span> <span class="fu">plot</span>(M, exp_.train_data, title<span class="op">=</span><span class="st">"</span><span class="sc">$</span>exp_name<span class="st">;</span><span class="sc">\n</span><span class="st"> </span><span class="sc">$</span>M_name<span class="st"> (</span><span class="sc">$</span>score<span class="st">)"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Errors:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        ids <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">vec</span>(<span class="fu">round</span>.(<span class="fu">probs</span>(M, exp_.train_data.X)) <span class="op">.!=</span> exp_.train_data.y))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        x_wrongly_labelled <span class="op">=</span> exp_.train_data.X[<span class="op">:</span>,ids]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scatter!</span>(plt, x_wrongly_labelled[<span class="fl">1</span>,<span class="op">:</span>], x_wrongly_labelled[<span class="fl">2</span>,<span class="op">:</span>], ms<span class="op">=</span><span class="fl">7.5</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        plts <span class="op">=</span> <span class="fu">vcat</span>(plts<span class="op">...</span>, plt)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>plt <span class="op">=</span> <span class="fu">plot</span>(plts<span class="op">...</span>, layout<span class="op">=</span>(<span class="fu">length</span>(choices),<span class="fu">length</span>(models)),size<span class="op">=</span>(<span class="fu">length</span>(choices)<span class="op">*</span><span class="fl">300</span>,<span class="fu">length</span>(models)<span class="op">*</span><span class="fl">300</span>))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">savefig</span>(plt, <span class="fu">joinpath</span>(www_path,<span class="st">"models_train_before.png"</span>))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.2: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>n_evals <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>n_rounds <span class="op">=</span> <span class="fl">50</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>evaluate_every <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">round</span>(n_rounds<span class="op">/</span>n_evals))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>n_folds <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="fu">run_experiments</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    experiments;</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    save_path<span class="op">=</span>output_path,evaluate_every<span class="op">=</span>evaluate_every,n_rounds<span class="op">=</span>n_rounds, n_folds<span class="op">=</span>n_folds, T<span class="op">=</span>T</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="bu">Serialization</span>.<span class="fu">serialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results.jls"</span>),results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plot_dict <span class="op">=</span> <span class="fu">Dict</span>(key <span class="op">=&gt;</span> <span class="fu">Dict</span>() <span class="cf">for</span> (key,val) <span class="kw">in</span> results)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>fold <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name, res) <span class="kw">in</span> results</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    exp_ <span class="op">=</span> res.experiment</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    plot_dict[name] <span class="op">=</span> <span class="fu">Dict</span>(key <span class="op">=&gt;</span> [] <span class="cf">for</span> (key,val) <span class="kw">in</span> exp_.generators)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    rec_sys <span class="op">=</span> exp_.recourse_systems[fold]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    sys_ids <span class="op">=</span> <span class="fu">collect</span>(exp_.system_identifiers)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="fu">length</span>(rec_sys)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>M</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        model_name, generator_name <span class="op">=</span> sys_ids[m]</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        M <span class="op">=</span> rec_sys[m].model</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="fu">round</span>(<span class="fu">model_evaluation</span>(M, exp_.test_data),digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        plt <span class="op">=</span> <span class="fu">plot</span>(M, exp_.test_data, title<span class="op">=</span><span class="st">"</span><span class="sc">$</span>name<span class="st">;</span><span class="sc">\n</span><span class="st"> </span><span class="sc">$</span>model_name<span class="st"> (</span><span class="sc">$</span>score<span class="st">)"</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Errors:</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        ids <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">vec</span>(<span class="fu">round</span>.(<span class="fu">probs</span>(M, exp_.test_data.X)) <span class="op">.!=</span> exp_.test_data.y))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        x_wrongly_labelled <span class="op">=</span> exp_.test_data.X[<span class="op">:</span>,ids]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scatter!</span>(plt, x_wrongly_labelled[<span class="fl">1</span>,<span class="op">:</span>], x_wrongly_labelled[<span class="fl">2</span>,<span class="op">:</span>], ms<span class="op">=</span><span class="fl">7.5</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        plot_dict[name][generator_name] <span class="op">=</span> <span class="fu">vcat</span>(plot_dict[name][generator_name], plt)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>plot_dict <span class="op">=</span> <span class="fu">Dict</span>(key <span class="op">=&gt;</span> <span class="fu">reduce</span>(vcat, [plots[key] for plots <span class="kw">in</span> <span class="fu">values</span>(plot_dict)]) <span class="cf">for</span> (key, value) <span class="kw">in</span> generators)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name, plts) <span class="kw">in</span> plot_dict</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(plts<span class="op">...</span>, layout<span class="op">=</span>(<span class="fu">length</span>(choices),<span class="fu">length</span>(models)),size<span class="op">=</span>(<span class="fu">length</span>(choices)<span class="op">*</span><span class="fl">300</span>,<span class="fu">length</span>(models)<span class="op">*</span><span class="fl">300</span>))</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">savefig</span>(plt, <span class="fu">joinpath</span>(www_path,<span class="st">"models_test_after_</span><span class="sc">$</span>(name)<span class="st">.png"</span>))</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-test-after">Figure&nbsp;<span>3.3</span></a> shows the test data after running the experiment.</p>
<div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"models_test_after"</span>)]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(Images.<span class="fu">load</span>(img))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-test-after" class="cell quarto-layout-panel" data-execution_count="9">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.3: Test data after experiment</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">AlgorithmicRecourseDynamics.Models</span>: model_evaluation</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>plot_dict <span class="op">=</span> <span class="fu">Dict</span>(key <span class="op">=&gt;</span> <span class="fu">Dict</span>() <span class="cf">for</span> (key,val) <span class="kw">in</span> results)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>fold <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name, res) <span class="kw">in</span> results</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    exp_ <span class="op">=</span> res.experiment</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    plot_dict[name] <span class="op">=</span> <span class="fu">Dict</span>(key <span class="op">=&gt;</span> [] <span class="cf">for</span> (key,val) <span class="kw">in</span> exp_.generators)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    rec_sys <span class="op">=</span> exp_.recourse_systems[fold]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    sys_ids <span class="op">=</span> <span class="fu">collect</span>(exp_.system_identifiers)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="fu">length</span>(rec_sys)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>M</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        model_name, generator_name <span class="op">=</span> sys_ids[m]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        M <span class="op">=</span> rec_sys[m].model</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> rec_sys[m].data</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="fu">round</span>(<span class="fu">model_evaluation</span>(M, data),digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        plt <span class="op">=</span> <span class="fu">plot</span>(M, data, title<span class="op">=</span><span class="st">"</span><span class="sc">$</span>name<span class="st">;</span><span class="sc">\n</span><span class="st"> </span><span class="sc">$</span>model_name<span class="st"> (</span><span class="sc">$</span>score<span class="st">)"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Errors:</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        ids <span class="op">=</span> <span class="fu">findall</span>(<span class="fu">vec</span>(<span class="fu">round</span>.(<span class="fu">probs</span>(M, data.X)) <span class="op">.!=</span> data.y))</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        x_wrongly_labelled <span class="op">=</span> data.X[<span class="op">:</span>,ids]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scatter!</span>(plt, x_wrongly_labelled[<span class="fl">1</span>,<span class="op">:</span>], x_wrongly_labelled[<span class="fl">2</span>,<span class="op">:</span>], ms<span class="op">=</span><span class="fl">7.5</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        plot_dict[name][generator_name] <span class="op">=</span> <span class="fu">vcat</span>(plot_dict[name][generator_name], plt)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>plot_dict <span class="op">=</span> <span class="fu">Dict</span>(key <span class="op">=&gt;</span> <span class="fu">reduce</span>(vcat, [plots[key] for plots <span class="kw">in</span> <span class="fu">values</span>(plot_dict)]) <span class="cf">for</span> (key, value) <span class="kw">in</span> generators)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name, plts) <span class="kw">in</span> plot_dict</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(plts<span class="op">...</span>, layout<span class="op">=</span>(<span class="fu">length</span>(choices),<span class="fu">length</span>(models)),size<span class="op">=</span>(<span class="fu">length</span>(choices)<span class="op">*</span><span class="fl">300</span>,<span class="fu">length</span>(models)<span class="op">*</span><span class="fl">300</span>))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">savefig</span>(plt, <span class="fu">joinpath</span>(www_path,<span class="st">"models_train_after_</span><span class="sc">$</span>(name)<span class="st">.png"</span>))</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-train-after">Figure&nbsp;<span>3.4</span></a> shows the training data after running the experiment.</p>
<div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"models_train_after"</span>)]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(Images.<span class="fu">load</span>(img))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-train-after" class="cell quarto-layout-panel" data-execution_count="11">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.4: Training data after experiment</figcaption><p></p>
</figure>
</div>
</div>
</section>
<section id="plots" class="level4" data-number="3.0.1.2">
<h4 data-number="3.0.1.2" class="anchored" data-anchor-id="plots"><span class="header-section-number">3.0.1.2</span> Plots</h4>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="bu">Serialization</span>.<span class="fu">deserialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results.jls"</span>));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>line_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>errorbar_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (data_name, res) <span class="kw">in</span> results</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"line_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    line_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res,<span class="fu">maximum</span>(res.output.n))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"errorbar_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    errorbar_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="line-charts" class="level5" data-number="3.0.1.2.1">
<h5 data-number="3.0.1.2.1" class="anchored" data-anchor-id="line-charts"><span class="header-section-number">3.0.1.2.1</span> Line Charts</h5>
<p><a href="#fig-line">Figure&nbsp;<span>3.5</span></a> shows the evolution of the evaluation metrics over the course of the experiment.</p>
<div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"line_chart"</span>)]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(Images.<span class="fu">load</span>(img))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-line" class="cell quarto-layout-panel" data-execution_count="14">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.5: Line Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
<section id="error-bar-charts" class="level5" data-number="3.0.1.2.2">
<h5 data-number="3.0.1.2.2" class="anchored" data-anchor-id="error-bar-charts"><span class="header-section-number">3.0.1.2.2</span> Error Bar Charts</h5>
<p><a href="#fig-error">Figure&nbsp;<span>3.6</span></a> shows the evaluation metrics at the end of the experiments.</p>
<div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"errorbar_chart"</span>)]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(Images.<span class="fu">load</span>(img))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-error" class="cell quarto-layout-panel" data-execution_count="15">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.6: Error Bar Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
</section>
<section id="bootstrap" class="level4" data-number="3.0.1.3">
<h4 data-number="3.0.1.3" class="anchored" data-anchor-id="bootstrap"><span class="header-section-number">3.0.1.3</span> Bootstrap</h4>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>n_bootstrap <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">run_bootstrap</span>(results, n_bootstrap; filename<span class="op">=</span><span class="fu">joinpath</span>(output_path,<span class="st">"bootstrap.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-app-synthetic-paper" class="level4" data-number="3.0.1.4">
<h4 data-number="3.0.1.4" class="anchored" data-anchor-id="sec-app-synthetic-paper"><span class="header-section-number">3.0.1.4</span> Chart in paper</h4>
<p><a href="#fig-paper">Figure&nbsp;<span>3.7</span></a> shows the chart that went into the paper.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span>, <span class="bu">Statistics</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> results[<span class="op">:</span>overlapping].output</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[x <span class="op">∈</span> <span class="fu">maximum</span>(df.n) for x <span class="kw">in</span> df.n],<span class="op">:</span>]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> <span class="fu">groupby</span>(df, [<span class="op">:</span>generator, <span class="op">:</span>model, <span class="op">:</span>n, <span class="op">:</span>name, <span class="op">:</span>scope])</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">combine</span>(gdf, <span class="op">:</span>value <span class="op">=&gt;</span> (x <span class="op">-&gt;</span> [(<span class="fu">mean</span>(x),<span class="fu">mean</span>(x)<span class="fu">+std</span>(x),<span class="fu">mean</span>(x)<span class="fu">-std</span>(x))]) <span class="op">=&gt;</span> [<span class="op">:</span>mean, <span class="op">:</span>ymax, <span class="op">:</span>ymin])</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[[name <span class="kw">in</span> [<span class="op">:</span>decisiveness, <span class="op">:</span>disagreement, <span class="op">:</span>mmd, <span class="op">:</span>mmd_grid, <span class="op">:</span>model_performance] for name <span class="kw">in</span> df_plot.name],<span class="op">:</span>]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[.!(df_plot.name<span class="op">.==:</span>mmd <span class="op">.&amp;&amp;</span> df_plot.scope<span class="op">.==:</span>model),<span class="op">:</span>]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">mapcols</span>(x <span class="op">-&gt;</span> <span class="fu">typeof</span>(x) <span class="op">==</span> <span class="dt">Vector</span>{<span class="dt">Symbol</span>} ? <span class="fu">string</span>.(x) <span class="op">:</span> x, df_plot)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"decisiveness"</span> ? <span class="st">"Decisiveness"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"disagreement"</span> ? <span class="st">"Disagreement"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd"</span> ? <span class="st">"MMD (domain)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd_grid"</span> ? <span class="st">"MMD (model)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"model_performance"</span> ? <span class="st">"Performance"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"REVISE"</span> ? <span class="st">"Latent"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"FluxEnsemble"</span> ? <span class="st">"Deep Ensemble"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"FluxModel"</span> ? <span class="st">"MLP"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"LogisticRegression"</span> ? <span class="st">"Linear"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>ncol <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.model))</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>nrow <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.name))</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>scale_ <span class="op">=</span> <span class="fl">1.5</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>R<span class="st">"""</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="st">library(data.table)</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="st">df_plot &lt;- data.table(</span><span class="sc">$</span>df_plot<span class="st">)</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="st">name_order &lt;- c(</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="st">    "MMD (domain)",</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="st">    "MMD (model)",</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="st">    "Performance",</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="st">    "Disagreement",</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="st">    "Decisiveness"</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="st">df_plot[,name:=factor(name, levels=name_order)]</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="st">model_order &lt;- c("Linear", "MLP", "Deep Ensemble")</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="st">df_plot[,model:=factor(model, levels=model_order)]</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="st">library(ggplot2)</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="st">plt &lt;- ggplot(df_plot) +</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_bar(aes(x=n, y=mean, fill=generator), stat="identity", alpha=0.5, position="dodge") +</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_pointrange(aes(x=n, y=mean, ymin=ymin, ymax=ymax, colour=generator), alpha=0.9, position=position_dodge(width=c(0.9,0.9)), size=0.5) +</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="st">    facet_grid(</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="st">        rows = vars(name),</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="st">        cols =  vars(model), </span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="st">        scales = "free_y"</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="st">    labs(y = "Value") + </span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_fill_discrete(name="Generator:") +</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_colour_discrete(name="Generator:") +</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="st">    theme(</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.title.x=element_blank(),</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.text.x=element_blank(),</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.ticks.x=element_blank(),</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="st">        legend.position="bottom"</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="st">    )</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="st">temp_path &lt;- file.path(tempdir(), "plot.png")</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a><span class="st">ggsave(temp_path, width=</span><span class="sc">$</span>ncol<span class="st"> * </span><span class="sc">$</span>scale_<span class="st">,height=</span><span class="sc">$</span>nrow<span class="st"> * </span><span class="sc">$</span>scale_<span class="st"> * 0.75) </span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">rcopy</span>(R<span class="st">"temp_path"</span>))</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_synthetic_results.png"</span>), img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-paper" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">load</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_synthetic_results.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.7: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="real-world-data" class="level3" data-number="3.0.2">
<h3 data-number="3.0.2" class="anchored" data-anchor-id="real-world-data"><span class="header-section-number">3.0.2</span> Real-World Data</h3>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>LogisticRegression, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>FluxModel, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>FluxEnsemble</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>generators <span class="op">=</span> <span class="fu">Dict</span>(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Greedy<span class="op">=&gt;</span><span class="fu">GreedyGenerator</span>(), </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Generic<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>REVISE<span class="op">=&gt;</span><span class="fu">REVISEGenerator</span>(),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>DICE<span class="op">=&gt;</span><span class="fu">DiCEGenerator</span>(),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>max_obs <span class="op">=</span> <span class="fl">2500</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>data_sets <span class="op">=</span> <span class="fu">load_real_world</span>(max_obs)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>choices <span class="op">=</span> [</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># :cal_housing, </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># :credit_default, </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>gmsc, </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>data_sets <span class="op">=</span> <span class="fu">filter</span>(p <span class="op">-&gt;</span> p[<span class="fl">1</span>] <span class="kw">in</span> choices, data_sets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CounterfactualExplanations.DataPreprocessing</span>: unpack</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> <span class="fl">500</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">data_loader</span>(data<span class="op">::</span><span class="dt">CounterfactualData</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    X, y <span class="op">=</span> <span class="fu">unpack</span>(data)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> Flux.<span class="fu">DataLoader</span>((X,y),batchsize<span class="op">=</span>bs)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>model_params <span class="op">=</span> (batch_norm<span class="op">=</span><span class="cn">false</span>,n_hidden<span class="op">=</span><span class="fl">64</span>,n_layers<span class="op">=</span><span class="fl">3</span>,dropout<span class="op">=</span><span class="cn">true</span>,p_dropout<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>experiments <span class="op">=</span> <span class="fu">set_up_experiments</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    data_sets,models,generators; </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    pre_train_models<span class="op">=</span><span class="fl">100</span>, model_params<span class="op">=</span>model_params, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    data_loader<span class="op">=</span>data_loader</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="experiment-1" class="level4" data-number="3.0.2.1">
<h4 data-number="3.0.2.1" class="anchored" data-anchor-id="experiment-1"><span class="header-section-number">3.0.2.1</span> Experiment</h4>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>n_evals <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>n_rounds <span class="op">=</span> <span class="fl">50</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>evaluate_every <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">round</span>(n_rounds<span class="op">/</span>n_evals))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>n_folds <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="fl">10000</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>generative_model_params <span class="op">=</span> (epochs<span class="op">=</span><span class="fl">250</span>, latent_dim<span class="op">=</span><span class="fl">8</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="fu">run_experiments</span>(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    experiments;</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    save_path<span class="op">=</span>output_path,evaluate_every<span class="op">=</span>evaluate_every,n_rounds<span class="op">=</span>n_rounds, n_folds<span class="op">=</span>n_folds, T<span class="op">=</span>T, n_samples<span class="op">=</span>n_samples,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    generative_model_params<span class="op">=</span>generative_model_params</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="bu">Serialization</span>.<span class="fu">serialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results.jls"</span>),results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plots-1" class="level4" data-number="3.0.2.2">
<h4 data-number="3.0.2.2" class="anchored" data-anchor-id="plots-1"><span class="header-section-number">3.0.2.2</span> Plots</h4>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="bu">Serialization</span>.<span class="fu">deserialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results.jls"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>line_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>errorbar_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (data_name, res) <span class="kw">in</span> results</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"line_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    line_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res,<span class="fu">maximum</span>(res.output.n))</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"errorbar_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    errorbar_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="line-charts-1" class="level5" data-number="3.0.2.2.1">
<h5 data-number="3.0.2.2.1" class="anchored" data-anchor-id="line-charts-1"><span class="header-section-number">3.0.2.2.1</span> Line Charts</h5>
<p><a href="#fig-real-line">Figure&nbsp;<span>3.8</span></a> shows the evolution of the evaluation metrics over the course of the experiment.</p>
<div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"line_chart"</span>)]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(<span class="fu">load</span>(img))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-real-line" class="cell quarto-layout-panel" data-execution_count="27">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.8: Line Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
<section id="error-bar-charts-1" class="level5" data-number="3.0.2.2.2">
<h5 data-number="3.0.2.2.2" class="anchored" data-anchor-id="error-bar-charts-1"><span class="header-section-number">3.0.2.2.2</span> Error Bar Charts</h5>
<p><a href="#fig-real-error">Figure&nbsp;<span>3.9</span></a> shows the evaluation metrics at the end of the experiments.</p>
<div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"errorbar_chart"</span>)]</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(<span class="fu">load</span>(img))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-real-error" class="cell quarto-layout-panel" data-execution_count="28">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.9: Error Bar Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
</section>
<section id="bootstrap-1" class="level4" data-number="3.0.2.3">
<h4 data-number="3.0.2.3" class="anchored" data-anchor-id="bootstrap-1"><span class="header-section-number">3.0.2.3</span> Bootstrap</h4>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>n_bootstrap <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">run_bootstrap</span>(results, n_bootstrap; filename<span class="op">=</span><span class="fu">joinpath</span>(output_path,<span class="st">"bootstrap.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chart-in-paper" class="level4" data-number="3.0.2.4">
<h4 data-number="3.0.2.4" class="anchored" data-anchor-id="chart-in-paper"><span class="header-section-number">3.0.2.4</span> Chart in paper</h4>
<p><a href="#fig-real-paper">Figure&nbsp;<span>3.10</span></a> shows the chart that went into the paper.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span>, <span class="bu">Statistics</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>model_ <span class="op">=</span> <span class="op">:</span>FluxEnsemble</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">DataFrame</span>() </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (key, val) <span class="kw">in</span> results</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    df_ <span class="op">=</span> <span class="fu">deepcopy</span>(val.output)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    df_.dataset <span class="op">.=</span> key</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> <span class="fu">vcat</span>(df,df_)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df.n <span class="op">.==</span> <span class="fu">maximum</span>(df.n),<span class="op">:</span>]</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df.model <span class="op">.==</span> model_,<span class="op">:</span>]</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="fu">filter!</span>(<span class="op">:</span>value <span class="op">=&gt;</span> x <span class="op">-&gt;</span> !<span class="fu">any</span>(f <span class="op">-&gt;</span> <span class="fu">f</span>(x), (ismissing, isnothing, isnan)), df)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> <span class="fu">groupby</span>(df, [<span class="op">:</span>generator, <span class="op">:</span>dataset, <span class="op">:</span>n, <span class="op">:</span>name, <span class="op">:</span>scope])</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">combine</span>(gdf, <span class="op">:</span>value <span class="op">=&gt;</span> (x <span class="op">-&gt;</span> [(<span class="fu">mean</span>(x),<span class="fu">mean</span>(x)<span class="fu">+std</span>(x),<span class="fu">mean</span>(x)<span class="fu">-std</span>(x))]) <span class="op">=&gt;</span> [<span class="op">:</span>mean, <span class="op">:</span>ymax, <span class="op">:</span>ymin])</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[[name <span class="kw">in</span> [<span class="op">:</span>mmd, <span class="op">:</span>model_performance] for name <span class="kw">in</span> df_plot.name],<span class="op">:</span>]</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">mapcols</span>(x <span class="op">-&gt;</span> <span class="fu">typeof</span>(x) <span class="op">==</span> <span class="dt">Vector</span>{<span class="dt">Symbol</span>} ? <span class="fu">string</span>.(x) <span class="op">:</span> x, df_plot)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>df_plot.name <span class="op">.=</span> [r[<span class="op">:</span>name] <span class="op">==</span> <span class="st">"mmd"</span> ? <span class="st">"</span><span class="sc">$</span>(r[<span class="op">:</span>name])<span class="st">_</span><span class="sc">$</span>(r[<span class="op">:</span>scope])<span class="st">"</span> <span class="op">:</span> r[<span class="op">:</span>name] for r <span class="kw">in</span> <span class="fu">eachrow</span>(df_plot)]</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>dataset <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"cal_housing"</span> ? <span class="st">"California Housing"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>dataset)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>dataset <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"credit_default"</span> ? <span class="st">"Credit Default"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>dataset)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>dataset <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"gmsc"</span> ? <span class="st">"GMSC"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>dataset)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd_domain"</span> ? <span class="st">"MMD (domain)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd_model"</span> ? <span class="st">"MMD (model)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"model_performance"</span> ? <span class="st">"Performance"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"REVISE"</span> ? <span class="st">"Latent"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>ncol <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.dataset))</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>nrow <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.name))</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RCall</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>scale_ <span class="op">=</span> <span class="fl">1.75</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>R<span class="st">"""</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="st">library(ggplot2)</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="st">plt &lt;- ggplot(</span><span class="sc">$</span>df_plot<span class="st">) +</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_bar(aes(x=n, y=mean, fill=generator), stat="identity", alpha=0.5, position="dodge") +</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_pointrange( aes(x=n, y=mean, ymin=ymin, ymax=ymax, colour=generator), alpha=0.9, position=position_dodge(width=0.9), size=0.5) +</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="st">    facet_grid(</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="st">        rows = vars(name),</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="st">        cols =  vars(dataset), </span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="st">        scales = "free_y"</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="st">    labs(y = "Value") + </span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_fill_discrete(name="Generator:") +</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_colour_discrete(name="Generator:") +</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="st">    theme(</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.title.x=element_blank(),</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.text.x=element_blank(),</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.ticks.x=element_blank(),</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="st">        legend.position="bottom"</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a><span class="st">    )</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a><span class="st">temp_path &lt;- file.path(tempdir(), "plot.png")</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a><span class="st">ggsave(temp_path,width=</span><span class="sc">$</span>ncol<span class="st"> * </span><span class="sc">$</span>scale_<span class="st">,height=</span><span class="sc">$</span>nrow<span class="st"> * </span><span class="sc">$</span>scale_<span class="st"> * 0.8) </span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">rcopy</span>(R<span class="st">"temp_path"</span>))</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_real_world_results.png"</span>), img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-real-paper" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">load</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_real_world_results.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.10: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="mitigation-strategies" class="level3" data-number="3.0.3">
<h3 data-number="3.0.3" class="anchored" data-anchor-id="mitigation-strategies"><span class="header-section-number">3.0.3</span> Mitigation Strategies</h3>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>LogisticRegression, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>FluxModel, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>FluxEnsemble,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>generators <span class="op">=</span> <span class="fu">Dict</span>(</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Generic<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(decision_threshold<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Latent<span class="op">=&gt;</span><span class="fu">REVISEGenerator</span>(),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Generic_conservative<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(decision_threshold<span class="op">=</span><span class="fl">0.9</span>),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Gravitational<span class="op">=&gt;</span><span class="fu">GravitationalGenerator</span>(),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>ClapROAR<span class="op">=&gt;</span><span class="fu">ClapROARGenerator</span>()</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="synthetic" class="level4" data-number="3.0.3.1">
<h4 data-number="3.0.3.1" class="anchored" data-anchor-id="synthetic"><span class="header-section-number">3.0.3.1</span> Synthetic</h4>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>max_obs <span class="op">=</span> <span class="fl">1000</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>catalogue <span class="op">=</span> AlgorithmicRecourseDynamics.Data.<span class="fu">load_synthetic</span>(max_obs)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>choices <span class="op">=</span> [</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>linearly_separable, </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>overlapping, </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>circles, </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>moons,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>data_sets <span class="op">=</span> <span class="fu">filter</span>(p <span class="op">-&gt;</span> p[<span class="fl">1</span>] <span class="kw">in</span> choices, catalogue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>experiments <span class="op">=</span> <span class="fu">set_up_experiments</span>(data_sets,models,generators)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>n_evals <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>n_rounds <span class="op">=</span> <span class="fl">50</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>evaluate_every <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">round</span>(n_rounds<span class="op">/</span>n_evals))</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>n_folds <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Serialization</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="fu">run_experiments</span>(</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    experiments;</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    save_path<span class="op">=</span>output_path,evaluate_every<span class="op">=</span>evaluate_every,n_rounds<span class="op">=</span>n_rounds, n_folds<span class="op">=</span>n_folds, T<span class="op">=</span>T</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="bu">Serialization</span>.<span class="fu">serialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results_synthetic.jls"</span>),results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plots-2" class="level4" data-number="3.0.3.2">
<h4 data-number="3.0.3.2" class="anchored" data-anchor-id="plots-2"><span class="header-section-number">3.0.3.2</span> Plots</h4>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Serialization</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="bu">Serialization</span>.<span class="fu">deserialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results_synthetic.jls"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>line_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>errorbar_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (data_name, res) <span class="kw">in</span> results</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"line_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    line_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res,<span class="fu">maximum</span>(res.output.n))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"errorbar_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    errorbar_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="line-charts-2" class="level5" data-number="3.0.3.2.1">
<h5 data-number="3.0.3.2.1" class="anchored" data-anchor-id="line-charts-2"><span class="header-section-number">3.0.3.2.1</span> Line Charts</h5>
<p><a href="#fig-mit-line">Figure&nbsp;<span>3.11</span></a> shows the evolution of the evaluation metrics over the course of the experiment.</p>
<div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"line_chart"</span>) <span class="op">.&amp;&amp;</span> .!<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"latent"</span>)]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(<span class="fu">load</span>(img))</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-mit-line" class="cell quarto-layout-panel" data-execution_count="39">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.11: Line Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
<section id="error-bar-charts-2" class="level5" data-number="3.0.3.2.2">
<h5 data-number="3.0.3.2.2" class="anchored" data-anchor-id="error-bar-charts-2"><span class="header-section-number">3.0.3.2.2</span> Error Bar Charts</h5>
<p><a href="#fig-mit-error">Figure&nbsp;<span>3.12</span></a> shows the evaluation metrics at the end of the experiments.</p>
<div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"errorbar_chart"</span>) <span class="op">.&amp;&amp;</span> .!<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"latent"</span>)]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(<span class="fu">load</span>(img))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-mit-error" class="cell quarto-layout-panel" data-execution_count="40">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.12: Error Bar Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
</section>
<section id="bootstrap-2" class="level4" data-number="3.0.3.3">
<h4 data-number="3.0.3.3" class="anchored" data-anchor-id="bootstrap-2"><span class="header-section-number">3.0.3.3</span> Bootstrap</h4>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>n_bootstrap <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">run_bootstrap</span>(results, n_bootstrap; filename<span class="op">=</span><span class="fu">joinpath</span>(output_path,<span class="st">"bootstrap_synthetic.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chart-in-paper-1" class="level4" data-number="3.0.3.4">
<h4 data-number="3.0.3.4" class="anchored" data-anchor-id="chart-in-paper-1"><span class="header-section-number">3.0.3.4</span> Chart in paper</h4>
<p><a href="#fig-mit-paper">Figure&nbsp;<span>3.13</span></a> shows the chart that went into the paper.</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span>, <span class="bu">Statistics</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> results[<span class="op">:</span>overlapping].output</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df.n <span class="op">.==</span> <span class="fu">maximum</span>(df.n),<span class="op">:</span>]</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> <span class="fu">groupby</span>(df, [<span class="op">:</span>generator, <span class="op">:</span>model, <span class="op">:</span>n, <span class="op">:</span>name, <span class="op">:</span>scope])</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">combine</span>(gdf, <span class="op">:</span>value <span class="op">=&gt;</span> (x <span class="op">-&gt;</span> [(<span class="fu">mean</span>(x),<span class="fu">mean</span>(x)<span class="fu">+std</span>(x),<span class="fu">mean</span>(x)<span class="fu">-std</span>(x))]) <span class="op">=&gt;</span> [<span class="op">:</span>mean, <span class="op">:</span>ymax, <span class="op">:</span>ymin])</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[[name <span class="kw">in</span> [<span class="op">:</span>mmd, <span class="op">:</span>mmd_grid, <span class="op">:</span>model_performance] for name <span class="kw">in</span> df_plot.name],<span class="op">:</span>]</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[.!(df_plot.name<span class="op">.==:</span>mmd <span class="op">.&amp;&amp;</span> df_plot.scope<span class="op">.==:</span>model),<span class="op">:</span>]</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">mapcols</span>(x <span class="op">-&gt;</span> <span class="fu">typeof</span>(x) <span class="op">==</span> <span class="dt">Vector</span>{<span class="dt">Symbol</span>} ? <span class="fu">string</span>.(x) <span class="op">:</span> x, df_plot)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd"</span> ? <span class="st">"MMD (domain)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd_grid"</span> ? <span class="st">"MMD (model)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"model_performance"</span> ? <span class="st">"Performance"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"Generic"</span> ? <span class="st">"Generic (γ=0.5)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"Generic_conservative"</span> ? <span class="st">"Generic (γ=0.9)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"FluxEnsemble"</span> ? <span class="st">"Deep Ensemble"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"FluxModel"</span> ? <span class="st">"MLP"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"LogisticRegression"</span> ? <span class="st">"Linear"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>ncol <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.model))</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>nrow <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.name))</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RCall</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>scale_ <span class="op">=</span> <span class="fl">2.0</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>R<span class="st">"""</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="st">library(data.table)</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="st">df_plot &lt;- data.table(</span><span class="sc">$</span>df_plot<span class="st">)</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="st">model_order &lt;- c("Linear", "MLP", "Deep Ensemble")</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="st">df_plot[,model:=factor(model, levels=model_order)]</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a><span class="st">library(ggplot2)</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="st">plt &lt;- ggplot(</span><span class="sc">$</span>df_plot<span class="st">) +</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_bar(aes(x=n, y=mean, fill=generator), stat="identity", alpha=0.5, position="dodge") +</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_pointrange( aes(x=n, y=mean, ymin=ymin, ymax=ymax, colour=generator), alpha=0.9, position=position_dodge(width=0.9), size=0.5) +</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a><span class="st">    facet_grid(</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a><span class="st">        rows = vars(name),</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a><span class="st">        cols =  vars(model), </span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a><span class="st">        scales = "free_y"</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a><span class="st">    labs(y = "Value") + </span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_fill_discrete(name="Generator:") +</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_colour_discrete(name="Generator:") +</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="st">    theme(</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.title.x=element_blank(),</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.text.x=element_blank(),</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.ticks.x=element_blank(),</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a><span class="st">        legend.position="bottom"</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a><span class="st">    guides(fill=guide_legend(ncol=3))</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a><span class="st">temp_path &lt;- file.path(tempdir(), "plot.png")</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a><span class="st">ggsave(temp_path,width=</span><span class="sc">$</span>ncol<span class="st"> * </span><span class="sc">$</span>scale_<span class="st">,height=</span><span class="sc">$</span>nrow<span class="st"> * </span><span class="sc">$</span>scale_<span class="st"> * 0.8) </span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">rcopy</span>(R<span class="st">"temp_path"</span>))</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_synthetic_results.png"</span>), img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-mit-paper" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">load</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_synthetic_results.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.13: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</section>
<section id="latent-space-search" class="level4" data-number="3.0.3.5">
<h4 data-number="3.0.3.5" class="anchored" data-anchor-id="latent-space-search"><span class="header-section-number">3.0.3.5</span> Latent Space Search</h4>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>generators <span class="op">=</span> <span class="fu">Dict</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Latent<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(decision_threshold<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Latent_conservative<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(decision_threshold<span class="op">=</span><span class="fl">0.9</span>),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Gravitational<span class="op">=&gt;</span><span class="fu">GravitationalGenerator</span>(),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>ClapROAR<span class="op">=&gt;</span><span class="fu">ClapROARGenerator</span>()</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>experiments <span class="op">=</span> <span class="fu">set_up_experiments</span>(data_sets,models,generators)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>n_evals <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>n_rounds <span class="op">=</span> <span class="fl">50</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>evaluate_every <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">round</span>(n_rounds<span class="op">/</span>n_evals))</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>n_folds <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Serialization</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="fu">run_experiments</span>(</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    experiments;</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    save_path<span class="op">=</span>output_path,evaluate_every<span class="op">=</span>evaluate_every,n_rounds<span class="op">=</span>n_rounds, n_folds<span class="op">=</span>n_folds, T<span class="op">=</span>T</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="bu">Serialization</span>.<span class="fu">serialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results_synthetic_latent.jls"</span>),results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Serialization</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="bu">Serialization</span>.<span class="fu">deserialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results_synthetic_latent.jls"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>line_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>errorbar_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (data_name, res) <span class="kw">in</span> results</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"line_chart_latent_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    line_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res,<span class="fu">maximum</span>(res.output.n))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"errorbar_chart_latent_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    errorbar_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plots-3" class="level4" data-number="3.0.3.6">
<h4 data-number="3.0.3.6" class="anchored" data-anchor-id="plots-3"><span class="header-section-number">3.0.3.6</span> Plots</h4>
<section id="line-charts-3" class="level5" data-number="3.0.3.6.1">
<h5 data-number="3.0.3.6.1" class="anchored" data-anchor-id="line-charts-3"><span class="header-section-number">3.0.3.6.1</span> Line Charts</h5>
<p><a href="#fig-mit-line-latent">Figure&nbsp;<span>3.14</span></a> shows the evolution of the evaluation metrics over the course of the experiment.</p>
<div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"line_chart"</span>) <span class="op">.&amp;&amp;</span> <span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"latent"</span>)]</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(<span class="fu">load</span>(img))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-mit-line-latent" class="cell quarto-layout-panel" data-execution_count="49">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.14: Line Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
<section id="error-bar-charts-3" class="level5" data-number="3.0.3.6.2">
<h5 data-number="3.0.3.6.2" class="anchored" data-anchor-id="error-bar-charts-3"><span class="header-section-number">3.0.3.6.2</span> Error Bar Charts</h5>
<p><a href="#fig-mit-error-latent">Figure&nbsp;<span>3.15</span></a> shows the evaluation metrics at the end of the experiments.</p>
<div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">readdir</span>(www_path)[<span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"errorbar_chart"</span>) <span class="op">.&amp;&amp;</span> <span class="fu">contains</span>.(<span class="fu">readdir</span>(www_path),<span class="st">"latent"</span>)]</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> <span class="fu">joinpath</span>.(www_path,img_files)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img <span class="kw">in</span> img_files</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(<span class="fu">load</span>(img))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-mit-error-latent" class="cell quarto-layout-panel" data-execution_count="50">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;3.15: Error Bar Charts</figcaption><p></p>
</figure>
</div>
</div>
</section>
</section>
<section id="bootstrap-3" class="level4" data-number="3.0.3.7">
<h4 data-number="3.0.3.7" class="anchored" data-anchor-id="bootstrap-3"><span class="header-section-number">3.0.3.7</span> Bootstrap</h4>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>n_bootstrap <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">run_bootstrap</span>(results, n_bootstrap; filename<span class="op">=</span><span class="fu">joinpath</span>(output_path,<span class="st">"bootstrap_latent.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chart-in-paper-2" class="level4" data-number="3.0.3.8">
<h4 data-number="3.0.3.8" class="anchored" data-anchor-id="chart-in-paper-2"><span class="header-section-number">3.0.3.8</span> Chart in paper</h4>
<p><a href="#fig-mit-latent-paper">Figure&nbsp;<span>3.16</span></a> shows the chart that went into the paper.</p>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span>, <span class="bu">Statistics</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> results[<span class="op">:</span>overlapping].output</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df.n <span class="op">.==</span> <span class="fu">maximum</span>(df.n),<span class="op">:</span>]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> <span class="fu">groupby</span>(df, [<span class="op">:</span>generator, <span class="op">:</span>model, <span class="op">:</span>n, <span class="op">:</span>name, <span class="op">:</span>scope])</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">combine</span>(gdf, <span class="op">:</span>value <span class="op">=&gt;</span> (x <span class="op">-&gt;</span> [(<span class="fu">mean</span>(x),<span class="fu">mean</span>(x)<span class="fu">+std</span>(x),<span class="fu">mean</span>(x)<span class="fu">-std</span>(x))]) <span class="op">=&gt;</span> [<span class="op">:</span>mean, <span class="op">:</span>ymax, <span class="op">:</span>ymin])</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[[name <span class="kw">in</span> [<span class="op">:</span>mmd, <span class="op">:</span>mmd_grid, <span class="op">:</span>model_performance] for name <span class="kw">in</span> df_plot.name],<span class="op">:</span>]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[.!(df_plot.name<span class="op">.==:</span>mmd <span class="op">.&amp;&amp;</span> df_plot.scope<span class="op">.==:</span>model),<span class="op">:</span>]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">mapcols</span>(x <span class="op">-&gt;</span> <span class="fu">typeof</span>(x) <span class="op">==</span> <span class="dt">Vector</span>{<span class="dt">Symbol</span>} ? <span class="fu">string</span>.(x) <span class="op">:</span> x, df_plot)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd"</span> ? <span class="st">"MMD (domain)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd_grid"</span> ? <span class="st">"MMD (model)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"model_performance"</span> ? <span class="st">"Performance"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"Latent"</span> ? <span class="st">"Latent (γ=0.5)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"Latent_conservative"</span> ? <span class="st">"Latent (γ=0.9)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"FluxEnsemble"</span> ? <span class="st">"Deep Ensemble"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"FluxModel"</span> ? <span class="st">"MLP"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>model <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"LogisticRegression"</span> ? <span class="st">"Linear"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>model)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>ncol <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.model))</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>nrow <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.name))</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RCall</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>scale_ <span class="op">=</span> <span class="fl">1.9</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>R<span class="st">"""</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="st">library(data.table)</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="st">df_plot &lt;- data.table(</span><span class="sc">$</span>df_plot<span class="st">)</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="st">model_order &lt;- c("Linear", "MLP", "Deep Ensemble")</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="st">df_plot[,model:=factor(model, levels=model_order)]</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="st">library(ggplot2)</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="st">plt &lt;- ggplot(</span><span class="sc">$</span>df_plot<span class="st">) +</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_bar(aes(x=n, y=mean, fill=generator), stat="identity", alpha=0.5, position="dodge") +</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_pointrange( aes(x=n, y=mean, ymin=ymin, ymax=ymax, colour=generator), alpha=0.9, position=position_dodge(width=0.9), size=0.5) +</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="st">    facet_grid(</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="st">        rows = vars(name),</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="st">        cols =  vars(model), </span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="st">        scales = "free_y"</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="st">    labs(y = "Value") + </span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_fill_discrete(name="Generator:") +</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_colour_discrete(name="Generator:") +</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a><span class="st">    theme(</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.title.x=element_blank(),</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.text.x=element_blank(),</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.ticks.x=element_blank(),</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="st">        legend.position="bottom"</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="st">    guides(fill=guide_legend(ncol=4))</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="st">temp_path &lt;- file.path(tempdir(), "plot.png")</span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="st">ggsave(temp_path,width=</span><span class="sc">$</span>ncol<span class="st"> * </span><span class="sc">$</span>scale_<span class="st">,height=</span><span class="sc">$</span>nrow<span class="st"> * </span><span class="sc">$</span>scale_<span class="st"> * 0.8) </span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">rcopy</span>(R<span class="st">"temp_path"</span>))</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_synthetic_latent_results.png"</span>), img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-mit-latent-paper" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">load</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_synthetic_latent_results.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.16: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="real-world" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="real-world"><span class="header-section-number">3.1</span> Real World</h2>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>generators <span class="op">=</span> <span class="fu">Dict</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Generic<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(decision_threshold<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Latent<span class="op">=&gt;</span><span class="fu">REVISEGenerator</span>(),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Generic_conservative<span class="op">=&gt;</span><span class="fu">GenericGenerator</span>(decision_threshold<span class="op">=</span><span class="fl">0.9</span>),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>Gravitational<span class="op">=&gt;</span><span class="fu">GravitationalGenerator</span>(),</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>ClapROAR<span class="op">=&gt;</span><span class="fu">ClapROARGenerator</span>()</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>max_obs <span class="op">=</span> <span class="fl">2500</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> <span class="fu">data_dir</span>(<span class="st">"real_world"</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>data_sets <span class="op">=</span> AlgorithmicRecourseDynamics.Data.<span class="fu">load_real_world</span>(max_obs; data_dir<span class="op">=</span>data_path)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>choices <span class="op">=</span> [</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>cal_housing, </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>credit_default, </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span>gmsc, </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>data_sets <span class="op">=</span> <span class="fu">filter</span>(p <span class="op">-&gt;</span> p[<span class="fl">1</span>] <span class="kw">in</span> choices, data_sets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CounterfactualExplanations.DataPreprocessing</span>: unpack</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> <span class="fl">500</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">data_loader</span>(data<span class="op">::</span><span class="dt">CounterfactualData</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    X, y <span class="op">=</span> <span class="fu">unpack</span>(data)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> Flux.<span class="fu">DataLoader</span>((X,y),batchsize<span class="op">=</span>bs)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>model_params <span class="op">=</span> (batch_norm<span class="op">=</span><span class="cn">false</span>,n_hidden<span class="op">=</span><span class="fl">64</span>,n_layers<span class="op">=</span><span class="fl">3</span>,dropout<span class="op">=</span><span class="cn">true</span>,p_dropout<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>experiments <span class="op">=</span> <span class="fu">set_up_experiments</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    data_sets,models,generators; </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    pre_train_models<span class="op">=</span><span class="fl">100</span>, model_params<span class="op">=</span>model_params, </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    data_loader<span class="op">=</span>data_loader</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>n_evals <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>n_rounds <span class="op">=</span> <span class="fl">50</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>evaluate_every <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">round</span>(n_rounds<span class="op">/</span>n_evals))</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>n_folds <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="fl">10000</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>generative_model_params <span class="op">=</span> (epochs<span class="op">=</span><span class="fl">250</span>, latent_dim<span class="op">=</span><span class="fl">8</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="fu">run_experiments</span>(</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    experiments;</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    save_path<span class="op">=</span>output_path,evaluate_every<span class="op">=</span>evaluate_every,n_rounds<span class="op">=</span>n_rounds, n_folds<span class="op">=</span>n_folds, T<span class="op">=</span>T, n_samples<span class="op">=</span>n_samples,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    generative_model_params<span class="op">=</span>generative_model_params</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="bu">Serialization</span>.<span class="fu">serialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results_real_world.jls"</span>),results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Serialization</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="bu">Serialization</span>.<span class="fu">deserialize</span>(<span class="fu">joinpath</span>(output_path,<span class="st">"results_real_world.jls"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>line_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>errorbar_charts <span class="op">=</span> <span class="fu">Dict</span>()</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (data_name, res) <span class="kw">in</span> results</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"line_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    line_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    plt <span class="op">=</span> <span class="fu">plot</span>(res,<span class="fu">maximum</span>(res.output.n))</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path, <span class="st">"errorbar_chart_</span><span class="sc">$</span>(data_name)<span class="st">.png"</span>), plt)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    errorbar_charts[data_name] <span class="op">=</span> plt</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="bootstrap-4" class="level4" data-number="3.1.0.1">
<h4 data-number="3.1.0.1" class="anchored" data-anchor-id="bootstrap-4"><span class="header-section-number">3.1.0.1</span> Bootstrap</h4>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>n_bootstrap <span class="op">=</span> <span class="fl">10</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">run_bootstrap</span>(results, n_bootstrap; filename<span class="op">=</span><span class="fu">joinpath</span>(output_path,<span class="st">"bootstrap_real_world.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chart-in-paper-3" class="level4" data-number="3.1.0.2">
<h4 data-number="3.1.0.2" class="anchored" data-anchor-id="chart-in-paper-3"><span class="header-section-number">3.1.0.2</span> Chart in paper</h4>
<p><a href="#fig-mit-latent-paper">Figure&nbsp;<span>3.16</span></a> shows the chart that went into the paper.</p>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span>, <span class="bu">Statistics</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>model_ <span class="op">=</span> <span class="op">:</span>FluxEnsemble</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">DataFrame</span>() </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (key, val) <span class="kw">in</span> results</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    df_ <span class="op">=</span> <span class="fu">deepcopy</span>(val.output)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    df_.dataset <span class="op">.=</span> key</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> <span class="fu">vcat</span>(df,df_)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df.n <span class="op">.==</span> <span class="fu">maximum</span>(df.n),<span class="op">:</span>]</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df.model <span class="op">.==</span> model_,<span class="op">:</span>]</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="fu">filter!</span>(<span class="op">:</span>value <span class="op">=&gt;</span> x <span class="op">-&gt;</span> !<span class="fu">any</span>(f <span class="op">-&gt;</span> <span class="fu">f</span>(x), (ismissing, isnothing, isnan)), df)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> <span class="fu">groupby</span>(df, [<span class="op">:</span>generator, <span class="op">:</span>dataset, <span class="op">:</span>n, <span class="op">:</span>name, <span class="op">:</span>scope])</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">combine</span>(gdf, <span class="op">:</span>value <span class="op">=&gt;</span> (x <span class="op">-&gt;</span> [(<span class="fu">mean</span>(x),<span class="fu">mean</span>(x)<span class="fu">+std</span>(x),<span class="fu">mean</span>(x)<span class="fu">-std</span>(x))]) <span class="op">=&gt;</span> [<span class="op">:</span>mean, <span class="op">:</span>ymax, <span class="op">:</span>ymin])</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[[name <span class="kw">in</span> [<span class="op">:</span>mmd, <span class="op">:</span>model_performance] for name <span class="kw">in</span> df_plot.name],<span class="op">:</span>]</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot[.!(df_plot.name<span class="op">.==:</span>mmd <span class="op">.&amp;&amp;</span> df_plot.scope<span class="op">.!=:</span>model),<span class="op">:</span>]</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> <span class="fu">mapcols</span>(x <span class="op">-&gt;</span> <span class="fu">typeof</span>(x) <span class="op">==</span> <span class="dt">Vector</span>{<span class="dt">Symbol</span>} ? <span class="fu">string</span>.(x) <span class="op">:</span> x, df_plot)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>dataset <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"cal_housing"</span> ? <span class="st">"California Housing"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>dataset)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>dataset <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"credit_default"</span> ? <span class="st">"Credit Default"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>dataset)</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>dataset <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"gmsc"</span> ? <span class="st">"GMSC"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>dataset)</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"mmd"</span> ? <span class="st">"MMD (model)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>name <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"model_performance"</span> ? <span class="st">"Performance"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>name)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"Generic"</span> ? <span class="st">"Generic (γ=0.5)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(df_plot, <span class="op">:</span>generator <span class="op">=&gt;</span> (X <span class="op">-&gt;</span> [x<span class="op">==</span><span class="st">"Generic_conservative"</span> ? <span class="st">"Generic (γ=0.9)"</span> <span class="op">:</span> x for x <span class="kw">in</span> X]) <span class="op">=&gt;</span> <span class="op">:</span>generator)</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>ncol <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.dataset))</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>nrow <span class="op">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_plot.name))</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RCall</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>scale_ <span class="op">=</span> <span class="fl">2.0</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>R<span class="st">"""</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="st">library(ggplot2)</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a><span class="st">plt &lt;- ggplot(</span><span class="sc">$</span>df_plot<span class="st">) +</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_bar(aes(x=n, y=mean, fill=generator), stat="identity", alpha=0.5, position="dodge") +</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a><span class="st">    geom_pointrange( aes(x=n, y=mean, ymin=ymin, ymax=ymax, colour=generator), alpha=0.9, position=position_dodge(width=0.9), size=0.5) +</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a><span class="st">    facet_grid(</span></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a><span class="st">        rows = vars(name),</span></span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a><span class="st">        cols =  vars(dataset), </span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a><span class="st">        scales = "free_y"</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a><span class="st">    labs(y = "Value") + </span></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_fill_discrete(name="Generator:") +</span></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a><span class="st">    scale_colour_discrete(name="Generator:") +</span></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a><span class="st">    theme(</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.title.x=element_blank(),</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.text.x=element_blank(),</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a><span class="st">        axis.ticks.x=element_blank(),</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a><span class="st">        legend.position="bottom"</span></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a><span class="st">    ) +</span></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a><span class="st">    guides(fill=guide_legend(ncol=3))</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a><span class="st">temp_path &lt;- file.path(tempdir(), "plot.png")</span></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a><span class="st">ggsave(temp_path,width=</span><span class="sc">$</span>ncol<span class="st"> * </span><span class="sc">$</span>scale_<span class="st">,height=</span><span class="sc">$</span>nrow<span class="st"> * </span><span class="sc">$</span>scale_<span class="st"> * 0.85) </span></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">rcopy</span>(R<span class="st">"temp_path"</span>))</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">save</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_real_world_results.png"</span>), img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-mit-real-paper" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>Images.<span class="fu">load</span>(<span class="fu">joinpath</span>(www_path,<span class="st">"paper_real_world_results.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.17: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../sections/data_preprocessing/index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Preprocessing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../sections/generators/index.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Generators</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>